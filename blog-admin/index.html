<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog CMS Access</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    #auth-container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #2c3e50;
      margin-top: 0;
    }
    #manual-auth {
      margin-top: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e1e4e8;
    }
    #invite-url {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    #submit-invite {
      background: #4a89dc;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      transition: background 0.3s;
    }
    #submit-invite:hover {
      background: #3b7dd8;
    }
    #status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div id="auth-container">
    <h2>Blog CMS Access</h2>
    <div id="netlify-identity-widget"></div>
    
    <div id="manual-auth">
      <h3>Manual Invitation Setup</h3>
      <p>If your invitation link didn't work automatically:</p>
      <ol>
        <li>Click the invitation link in your email</li>
        <li>Copy the <strong>entire URL</strong> from your address bar</li>
        <li>Paste it below and click "Submit"</li>
      </ol>
      <input type="text" id="invite-url" placeholder="Paste the complete invitation URL here">
      <button id="submit-invite">Submit Invitation</button>
      <div id="status-message"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set up button click handler
      document.getElementById('submit-invite').addEventListener('click', processInvite);
      
      // Also allow pressing Enter in the input field
      document.getElementById('invite-url').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          processInvite();
        }
      });

      function showStatus(message, isError) {
        const statusEl = document.getElementById('status-message');
        statusEl.textContent = message;
        statusEl.className = isError ? 'error' : 'success';
        statusEl.style.display = 'block';
      }

      function processInvite() {
        const urlInput = document.getElementById('invite-url').value.trim();
        
        if (!urlInput) {
          showStatus('Please paste the invitation URL first', true);
          return;
        }

        try {
          // Create URL object (handles both absolute and relative URLs)
          const urlObj = new URL(urlInput.startsWith('http') ? urlInput : `https://example.com${urlInput}`);
          
          // Extract token from either hash or search parameters
          const token = urlObj.hash.includes('invite_token') 
            ? urlObj.hash.split('invite_token=')[1].split('&')[0]
            : urlObj.searchParams.get('invite_token');
          
          if (token) {
            localStorage.setItem('netlify-invite-token', token);
            showStatus('Invitation accepted! Redirecting...', false);
            setTimeout(() => {
              window.location.href = '/blog-admin/';
            }, 1500);
          } else {
            showStatus('No invitation token found in the URL. Please check and try again.', true);
          }
        } catch (e) {
          showStatus('Invalid URL format. Please paste the complete invitation URL exactly as shown in your address bar.', true);
          console.error('URL processing error:', e);
        }
      }

      // Check for token in current URL
      function checkCurrentUrlForToken() {
        const currentUrl = new URL(window.location.href);
        const hashParams = new URLSearchParams(currentUrl.hash.slice(1));
        const token = currentUrl.searchParams.get('invite_token') || hashParams.get('invite_token');
        
        if (token) {
          localStorage.setItem('netlify-invite-token', token);
          window.location.href = '/blog-admin/';
        }
      }

      // Initialize Netlify Identity
      if (window.netlifyIdentity) {
        netlifyIdentity.on('init', user => {
          checkCurrentUrlForToken();
          
          const token = localStorage.getItem('netlify-invite-token');
          if (token) {
            netlifyIdentity.acceptInvite(token);
            localStorage.removeItem('netlify-invite-token');
            return;
          }
          
          if (!user) {
            netlifyIdentity.open('login');
          } else {
            // Load CMS after successful auth
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js';
            document.body.appendChild(script);
            document.getElementById('auth-container').style.display = 'none';
          }
        });
        
        netlifyIdentity.init();
      }
    });
  </script>
</body>
</html>
