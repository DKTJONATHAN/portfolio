<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Jonathan Mwaniki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tiny.cloud/1/mn8k8hdz6yfspjdieakr2wj6o17ul3zukzga01gsm1jdi0gp/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="login-section" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
            <form id="login-form">
                <input type="password" id="password" class="w-full p-2 mb-4 border rounded-md" placeholder="Enter admin password">
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">Login</button>
            </form>
            <p id="login-error" class="text-red-500 mt-2 hidden"></p>
        </div>
    </div>

    <div id="admin-section" class="min-h-screen p-4 hidden">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-4">Create Post</h2>
            <form id="create-post" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" name="title" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Slug</label>
                    <input type="text" name="slug" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" name="category" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Tags (comma-separated)</label>
                    <input type="text" name="tags" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Image URL</label>
                    <input type="text" name="image" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" name="date" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Content</label>
                    <textarea id="content-editor" name="content" class="w-full p-2 border rounded-md"></textarea>
                </div>
                <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Create Post</button>
            </form>
            <p id="error" class="text-red-500 hidden"></p>
            <p id="loading" class="text-blue-500 hidden">Loading...</p>

            <h2 class="text-2xl font-bold mb-4">Posts</h2>
            <div id="post-list" class="space-y-4"></div>
        </div>
    </div>

    <script>
        tinymce.init({
            selector: '#content-editor',
            plugins: 'lists link image',
            toolbar: 'undo redo | bold italic | bullist numlist | link image',
            menubar: false
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const error = document.getElementById('login-error');
            error.classList.add('hidden');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ password }).toString()
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadPosts();
                } else {
                    error.textContent = data.error || 'Invalid password';
                    error.classList.remove('hidden');
                }
            } catch (err) {
                error.textContent = 'Failed to login: ' + err.message;
                error.classList.remove('hidden');
            }
        });

        document.getElementById('create-post').addEventListener('submit', async (e) => {
            e.preventDefault();
            alert('Create Post: Form submitted'); // Mobile debug
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            loading.classList.remove('hidden');
            error.classList.add('hidden');

            const formData = new FormData(e.target);
            const postData = {
                title: formData.get('title'),
                slug: formData.get('slug'),
                category: formData.get('category'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag).join(','),
                image: formData.get('image') || '',
                date: formData.get('date'),
                content: tinymce.get('content-editor') ? tinymce.get('content-editor').getContent({ format: 'text' }) : formData.get('content')
            };

            try {
                const endpoint = e.target.dataset.editSlug ? '/api/update-post' : '/api/save-post';
                alert(`Create/Update Post: Sending form data to ${endpoint}`); // Mobile debug
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(postData).toString()
                });
                alert(`Create/Update Post: Response status ${response.status}`); // Mobile debug
                let responseData;
                try {
                    responseData = await response.json();
                    alert(`Create/Update Post: Response data ${JSON.stringify(responseData)}`); // Mobile debug
                } catch (jsonError) {
                    alert(`Create/Update Post: JSON error - ${jsonError.message}`); // Mobile debug
                    throw new Error(`Invalid JSON response from ${endpoint}`);
                }
                if (!response.ok) {
                    throw new Error(responseData.error || `Operation failed: ${response.status} ${response.statusText}`);
                }
                e.target.reset();
                if (tinymce.get('content-editor')) tinymce.get('content-editor').setContent('');
                e.target.querySelector('button[type="submit"]').textContent = 'Create Post';
                delete e.target.dataset.editSlug;
                loadPosts();
            } catch (err) {
                alert(`Create/Update Post: Error - ${err.message}`); // Mobile debug
                error.textContent = `Failed to ${e.target.dataset.editSlug ? 'update' : 'create'} post: ${err.message}`;
                error.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        });

        async function loadPosts() {
            const postList = document.getElementById('post-list');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            postList.innerHTML = '';
            loading.classList.remove('hidden');
            error.classList.add('hidden');

            try {
                alert('Load Posts: Fetching /api/list-posts'); // Mobile debug
                const response = await fetch('/api/list-posts?t=' + Date.now());
                alert(`Load Posts: Response status ${response.status}`); // Mobile debug
                if (!response.ok) {
                    const errorText = await response.text();
                    alert(`Load Posts: Error response - ${errorText}`); // Mobile debug
                    throw new Error(`Failed to fetch posts: ${response.status} ${response.statusText}`);
                }
                let posts;
                try {
                    posts = await response.json();
                    alert(`Load Posts: Received ${posts.length} posts`); // Mobile debug
                } catch (jsonError) {
                    alert(`Load Posts: JSON error - ${jsonError.message}`); // Mobile debug
                    throw new Error('Invalid JSON response from /api/list-posts');
                }
                if (posts.error) throw new Error(posts.error);
                posts.forEach(post => {
                    const postItem = document.createElement('div');
                    postItem.className = 'bg-white p-4 rounded-lg shadow-md flex justify-between items-center';
                    postItem.innerHTML = `
                        <div>
                            <h4 class="text-lg font-medium text-gray-900">${post.title}</h4>
                            <p class="text-sm text-gray-600">${post.date} | ${post.category}</p>
                        </div>
                        <div class="space-x-2">
                            <button class="edit-post bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600" data-slug="${post.slug}">Edit</button>
                            <button class="delete-post bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600" data-slug="${post.slug}">Delete</button>
                        </div>
                    `;
                    postList.appendChild(postItem);
                });

                document.querySelectorAll('.edit-post').forEach(button => {
                    button.addEventListener('click', async () => {
                        const slug = button.dataset.slug;
                        alert(`Edit Post: Fetching post ${slug}`); // Mobile debug
                        try {
                            const response = await fetch('/api/list-posts?t=' + Date.now());
                            alert(`Edit Post: Response status ${response.status}`); // Mobile debug
                            let posts;
                            try {
                                posts = await response.json();
                                alert(`Edit Post: Received ${posts.length} posts`); // Mobile debug
                            } catch (jsonError) {
                                alert(`Edit Post: JSON error - ${jsonError.message}`); // Mobile debug
                                throw new Error('Invalid JSON response from server');
                            }
                            const post = posts.find(p => p.slug === slug);
                            if (post) {
                                document.querySelector('input[name="title"]').value = post.title;
                                document.querySelector('input[name="slug"]').value = post.slug;
                                document.querySelector('input[name="category"]').value = post.category;
                                document.querySelector('input[name="tags"]').value = post.tags.join(', ');
                                document.querySelector('input[name="image"]').value = post.image || '';
                                document.querySelector('input[name="date"]').value = post.date;
                                if (tinymce.get('content-editor')) {
                                    tinymce.get('content-editor').setContent(post.content || '');
                                } else {
                                    document.getElementById('content-editor').value = post.content || '';
                                }
                                document.querySelector('#create-post button[type="submit"]').textContent = 'Update Post';
                                document.querySelector('#create-post').dataset.editSlug = slug;
                            }
                        } catch (err) {
                            alert(`Edit Post: Error - ${err.message}`); // Mobile debug
                            error.textContent = 'Failed to load post: ' + err.message;
                            error.classList.remove('hidden');
                        }
                    });
                });

                document.querySelectorAll('.delete-post').forEach(button => {
                    button.addEventListener('click', async () => {
                        if (!confirm('Are you sure you want to delete this post?')) return;
                        const slug = button.dataset.slug;
                        alert(`Delete Post: Sending delete for ${slug}`); // Mobile debug
                        try {
                            const response = await fetch('/api/delete-post', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: new URLSearchParams({ slug }).toString()
                            });
                            alert(`Delete Post: Response status ${response.status}`); // Mobile debug
                            let responseData;
                            try {
                                responseData = await response.json();
                                alert(`Delete Post: Response data ${JSON.stringify(responseData)}`); // Mobile debug
                            } catch (jsonError) {
                                alert(`Delete Post: JSON error - ${jsonError.message}`); // Mobile debug
                                throw new Error('Invalid JSON response from server');
                            }
                            if (!response.ok) {
                                throw new Error(responseData.error || 'Failed to delete post');
                            }
                            loadPosts();
                        } catch (err) {
                            alert(`Delete Post: Error - ${err.message}`); // Mobile debug
                            error.textContent = 'Failed to delete post: ' + err.message;
                            error.classList.remove('hidden');
                        }
                    });
                });
            } catch (err) {
                alert(`Load Posts: Error - ${err.message}`); // Mobile debug
                error.textContent = `Failed to fetch posts: ${err.message}`;
                error.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }
    </script>
</body>
</html>