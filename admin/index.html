<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.2/dist/turndown.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .summernote-editor {
            border: 1px solid #d1d5db;
            border-radius: 0 0 8px 8px;
            padding: 12px;
            min-height: 50vh; /* Adaptive height: 50% of viewport */
            max-width: 100%; /* Constrain to parent width */
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 16px;
            -webkit-user-select: text !important;
            user-select: text !important;
            touch-action: manipulation;
        }
        .summernote-editor:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .note-toolbar {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 8px;
            padding: 8px;
            background: #f3f4f6;
            border-bottom: 1px solid #d1d5db;
            border-radius: 8px 8px 0 0;
            max-width: 100%; /* Prevent overflow */
            box-sizing: border-box;
        }
        .note-toolbar .note-btn {
            background: #e5e7eb;
            border: 1px solid #d1d5db;
            padding: 6px;
            border-radius: 4px;
            font-size: 16px; /* Larger for icons */
            width: 36px; /* Fixed size for icons */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .note-toolbar .note-btn:hover {
            background: #d1d5db;
        }
        .note-toolbar .note-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .custom-context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            padding: 8px 0;
        }
        .custom-context-menu button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .custom-context-menu button:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Admin Panel</h1>
                <p class="text-gray-600">Enter your password to continue</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div class="relative">
                    <input type="password" id="password" placeholder="Password" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                </div>
                <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105">
                    Login
                </button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden text-center"></p>
        </div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section" class="hidden min-h-screen">
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <h1 class="text-3xl font-bold text-gray-900">Blog Admin Panel</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Welcome, Admin</span>
                        <div class="h-8 w-8 bg-blue-600 rounded-full"></div>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Create/Edit Post Form -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Create Post</h2>
                        <form id="create-post" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                    <input type="text" name="title" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Slug</label>
                                    <input type="text" name="slug" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                    <input type="text" name="category"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tags (comma-separated)</label>
                                    <input type="text" name="tags"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                                    <input type="text" name="image"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                    <input type="date" name="date" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                                <div id="content-editor"></div>
                            </div>
                            <div class="flex space-x-4">
                                <button type="submit" id="submit-post-button"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105 disabled:opacity-50 disabled:transform-none">
                                    Create Post
                                </button>
                                <button type="button" id="cancel-edit-button" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                    Cancel Edit
                                </button>
                                <button type="button" id="preview-button"
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                    Preview
                                </button>
                            </div>
                        </form>
                        <div class="mt-4">
                            <p id="error" class="text-red-500 text-sm hidden bg-red-50 border border-red-200 rounded-lg p-3"></p>
                            <p id="loading" class="text-blue-500 text-sm hidden bg-blue-50 border border-blue-200 rounded-lg p-3">Loading...</p>
                        </div>
                    </div>
                </div>
                <!-- Posts List -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 id="posts-title" class="text-xl font-bold text-gray-900">Posts</h2>
                        </div>
                        <div class="mb-6">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input type="text" id="search-input" placeholder="Search posts..."
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                            </div>
                        </div>
                        <div id="post-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center rounded-t-xl">
                <h3 class="text-2xl font-bold text-gray-900">Post Preview</h3>
                <button id="close-preview" class="text-gray-400 hover:text-gray-600 transition duration-200">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="preview-content" class="p-6"></div>
        </div>
    </div>

    <script>
        let allPosts = [];
        let filteredPosts = [];
        const turndownService = new TurndownService({
            headingStyle: 'atx',
            bulletListMarker: '-',
            codeBlockStyle: 'indented',
            linkStyle: 'inlined'
        });

        // Initialize Summernote
        function initSummernote() {
            $('#content-editor').summernote({
                height: '50vh', // Adaptive height
                minHeight: null,
                maxHeight: null,
                focus: false,
                toolbar: [
                    ['style', ['bold', 'italic', 'style']],
                    ['para', ['ul']],
                    ['insert', ['link', 'picture']],
                    ['misc', ['highlight']]
                ],
                styleTags: ['h1', 'h2'],
                placeholder: 'Type your content here...',
                callbacks: {
                    onInit: function() {
                        console.log('Summernote initialized');
                        const editor = $('#content-editor').next('.note-editor');
                        editor.find('.note-editable').addClass('summernote-editor');
                        // Prevent default click to avoid unwanted keyboard
                        editor.find('.note-editable').on('click', function(e) {
                            e.preventDefault();
                            $(this).blur();
                        });
                        // Double-tap to show keyboard
                        let lastTap = 0;
                        editor.find('.note-editable').on('touchend', function(e) {
                            const currentTime = new Date().getTime();
                            const tapLength = currentTime - lastTap;
                            if (tapLength < 500 && tapLength > 0) {
                                $(this).focus();
                            }
                            lastTap = currentTime;
                        });
                        // Long-press context menu
                        let pressTimer;
                        editor.find('.note-editable').on('touchstart', function(e) {
                            pressTimer = setTimeout(() => {
                                e.preventDefault();
                                const x = e.originalEvent.touches[0].clientX;
                                const y = e.originalEvent.touches[0].clientY;
                                const existingMenu = document.querySelector('.custom-context-menu');
                                if (existingMenu) existingMenu.remove();
                                const menu = document.createElement('div');
                                menu.className = 'custom-context-menu';
                                menu.style.left = `${x}px`;
                                menu.style.top = `${y}px`;
                                menu.innerHTML = `
                                    <button data-action="select">Select Text</button>
                                    <button data-action="link">Make Link</button>
                                    <button data-action="bold">Bold</button>
                                    <button data-action="italic">Italic</button>
                                    <button data-action="highlight">Highlight</button>
                                `;
                                document.body.appendChild(menu);
                                menu.querySelectorAll('button').forEach(button => {
                                    button.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        const action = e.target.dataset.action;
                                        if (action === 'select') {
                                            const range = document.caretRangeFromPoint(x, y);
                                            if (range) {
                                                const selection = window.getSelection();
                                                selection.removeAllRanges();
                                                selection.addRange(range);
                                                editor.find('.note-editable').focus();
                                            }
                                        } else if (action === 'link') {
                                            const url = prompt('Enter URL:');
                                            if (url) $('#content-editor').summernote('createLink', { url });
                                        } else if (action === 'bold') {
                                            $('#content-editor').summernote('bold');
                                        } else if (action === 'italic') {
                                            $('#content-editor').summernote('italic');
                                        } else if (action === 'highlight') {
                                            $('#content-editor').summernote('backColor', '#FFFF00');
                                        }
                                        menu.remove();
                                    });
                                });
                                const closeMenu = (e) => {
                                    if (!menu.contains(e.target)) {
                                        menu.remove();
                                        document.removeEventListener('click', closeMenu);
                                    }
                                };
                                document.addEventListener('click', closeMenu);
                            }, 500);
                        });
                        editor.find('.note-editable').on('touchend', () => clearTimeout(pressTimer));
                        editor.find('.note-editable').on('touchmove', () => clearTimeout(pressTimer));
                        // Customize toolbar icons
                        editor.find('.note-btn[title="Bold"]').html('<i class="fas fa-bold"></i>');
                        editor.find('.note-btn[title="Italic"]').html('<i class="fas fa-italic"></i>');
                        editor.find('.note-btn[title="Heading 1"]').html('<i class="fas fa-heading"></i>');
                        editor.find('.note-btn[title="Heading 2"]').html('<i class="fas fa-h2"></i>');
                        editor.find('.note-btn[title="Unordered List"]').html('<i class="fas fa-list-ul"></i>');
                        editor.find('.note-btn[title="Link"]').html('<i class="fas fa-link"></i>');
                        editor.find('.note-btn[title="Picture"]').html('<i class="fas fa-image"></i>');
                        editor.find('.note-btn[title="Highlight"]').html('<i class="fas fa-highlighter"></i>');
                        // Update active states
                        function updateToolbar() {
                            editor.find('.note-btn').removeClass('active');
                            if ($('#content-editor').summernote('isBold')) {
                                editor.find('.note-btn[title="Bold"]').addClass('active');
                            }
                            if ($('#content-editor').summernote('isItalic')) {
                                editor.find('.note-btn[title="Italic"]').addClass('active');
                            }
                            if ($('#content-editor').summernote('isHeading', 'H1')) {
                                editor.find('.note-btn[title="Heading 1"]').addClass('active');
                            }
                            if ($('#content-editor').summernote('isHeading', 'H2')) {
                                editor.find('.note-btn[title="Heading 2"]').addClass('active');
                            }
                            if ($('#content-editor').summernote('isUnorderedList')) {
                                editor.find('.note-btn[title="Unordered List"]').addClass('active');
                            }
                            if ($('#content-editor').summernote('isHighlight')) {
                                editor.find('.note-btn[title="Highlight"]').addClass('active');
                            }
                        }
                        editor.find('.note-editable').on('mouseup keyup', updateToolbar);
                    },
                    onPaste: function(e) {
                        const clipboardData = e.originalEvent.clipboardData.getData('text/plain');
                        const isPlainText = !/<[a-z][\s\S]*>/i.test(clipboardData);
                        if (isPlainText) {
                            let content = clipboardData;
                            content = content.replace(/(?:\*\*|__)(.*?)(?:\*\*|__)/g, '<strong>$1</strong>');
                            content = content.replace(/(?:\*|_)(.*?)(?:\*|_)/g, '<em>$1</em>');
                            content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
                            content = content.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
                            content = content.replace(/^(#{1,6})\s+(.+)$/gm, (match, hashes, text) => {
                                const level = hashes.length;
                                return `<h${level}>${text}</h${level}>`;
                            });
                            content = content.replace(/^(?:-|\*)\s+(.+)$/gm, '<li>$1</li>');
                            content = content.replace(/(<li>.+<\/li>)/g, '<ul>$1</ul>');
                            content = content.split('\n\n').map(line => {
                                if (!line.match(/^(?:<h\d>|<ul>|<img|<a)/)) {
                                    return `<p>${line}</p>`;
                                }
                                return line;
                            }).join('');
                            $('#content-editor').summernote('code', content);
                            e.preventDefault();
                        }
                    }
                }
            });
        }

        // Initialize editor after DOM is loaded
        $(document).ready(initSummernote);

        // Search functionality
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (searchTerm === '') {
                filteredPosts = [...allPosts];
            } else {
                filteredPosts = allPosts.filter(post => 
                    post.title && post.title.toLowerCase().includes(searchTerm)
                );
            }
            displayPosts(filteredPosts);
        });

        // Preview functionality
        document.getElementById('preview-button').addEventListener('click', () => {
            const formData = new FormData(document.getElementById('create-post'));
            const htmlContent = $('#content-editor').summernote('code');
            const previewData = {
                title: formData.get('title') || 'Untitled Post',
                category: formData.get('category') || 'Uncategorized',
                tags: formData.get('tags'),
                image: formData.get('image'),
                date: formData.get('date') || new Date().toISOString().split('T')[0],
                content: htmlContent || '<p class="text-gray-500 italic">No content available</p>'
            };
            const previewHTML = generatePreviewHTML(previewData);
            document.getElementById('preview-content').innerHTML = previewHTML;
            document.getElementById('preview-modal').classList.remove('hidden');
        });

        document.getElementById('close-preview').addEventListener('click', () => {
            document.getElementById('preview-modal').classList.add('hidden');
        });

        document.getElementById('preview-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('preview-modal').classList.add('hidden');
            }
        });

        function generatePreviewHTML(data) {
            const formattedDate = new Date(data.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const tags = data.tags ? data.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            return `
                <article class="prose prose-lg max-w-none">
                    ${data.image ? `<img src="${data.image}" alt="${data.title}" class="w-full h-64 object-cover rounded-lg mb-6">` : ''}
                    <header class="mb-8">
                        <h1 class="text-4xl font-bold text-gray-900 mb-4">${data.title}</h1>
                        <div class="flex items-center space-x-4 text-gray-600 mb-4">
                            <time datetime="${data.date}">${formattedDate}</time>
                            ${data.category ? `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">${data.category}</span>` : ''}
                        </div>
                        ${tags.length > 0 ? `
                            <div class="flex flex-wrap gap-2">
                                ${tags.map(tag => `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-sm">#${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </header>
                    <div class="prose prose-lg max-w-none">
                        ${data.content}
                    </div>
                </article>
            `;
        }

        // Login handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const error = document.getElementById('login-error');
            error.classList.add('hidden');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ password }).toString(),
                    signal: AbortSignal.timeout(10000)
                });
                if (response.ok) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('admin-section').classList.remove('hidden');
                    await loadPosts();
                } else {
                    const data = await response.json();
                    error.textContent = data.error || 'Invalid password';
                    error.classList.remove('hidden');
                }
            } catch (err) {
                error.textContent = 'Login failed: ' + err.message;
                error.classList.remove('hidden');
            }
        });

        // Create/Update post handler
        document.getElementById('create-post').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const submitButton = document.getElementById('submit-post-button');
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            submitButton.disabled = true;

            const formData = new FormData(e.target);
            const htmlContent = $('#content-editor').summernote('code');
            const markdownContent = turndownService.turndown(htmlContent || '');
            const postData = {
                title: formData.get('title'),
                slug: formData.get('slug'),
                category: formData.get('category'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag).join(','),
                image: formData.get('image') || '',
                date: formData.get('date'),
                content: markdownContent
            };
            console.log('HTML content:', htmlContent);
            console.log('Markdown content:', markdownContent);
            console.log('Post data to send:', postData);

            try {
                const endpoint = e.target.dataset.editSlug ? '/api/update-post' : '/api/save-post';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(postData).toString(),
                    signal: AbortSignal.timeout(30000)
                });
                let responseData;
                try {
                    responseData = await response.json();
                    console.log('Save/Update response:', responseData);
                } catch (jsonError) {
                    const rawResponse = await response.text();
                    console.log('Raw response:', rawResponse);
                    throw new Error('Invalid JSON response: ' + rawResponse);
                }
                if (!response.ok) {
                    throw new Error(responseData.error || `Operation failed: ${response.status}`);
                }
                e.target.reset();
                $('#content-editor').summernote('reset');
                submitButton.textContent = 'Create Post';
                document.getElementById('cancel-edit-button').classList.add('hidden');
                delete e.target.dataset.editSlug;
                await loadPosts();
            } catch (err) {
                error.textContent = `Failed to ${e.target.dataset.editSlug ? 'update' : 'create'} post: ${err.message}`;
                error.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                submitButton.disabled = false;
            }
        });

        // Cancel edit handler
        document.getElementById('cancel-edit-button').addEventListener('click', () => {
            document.getElementById('create-post').reset();
            $('#content-editor').summernote('reset');
            document.getElementById('submit-post-button').textContent = 'Create Post';
            document.getElementById('cancel-edit-button').classList.add('hidden');
            delete document.getElementById('create-post').dataset.editSlug;
        });

        // Display posts function
        function displayPosts(posts) {
            const postList = document.getElementById('post-list');
            const postsTitle = document.getElementById('posts-title');
            postsTitle.textContent = `Posts (${posts.length})`;
            if (posts.length === 0) {
                postList.innerHTML = '<p class="text-gray-500 text-center py-8">No posts found.</p>';
            } else {
                postList.innerHTML = posts.map(post => `
                    <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition duration-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-gray-900 truncate">${post.title || 'Untitled'}</h3>
                                <p class="text-sm text-gray-500 mt-1">${post.date || 'No date'}</p>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button class="edit-post bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-md text-sm transition duration-200" data-slug="${post.slug || ''}">
                                    Edit
                                </button>
                                <button class="delete-post bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-md text-sm transition duration-200" data-slug="${post.slug || ''}">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            document.querySelectorAll('.edit-post').forEach(button => {
                button.removeEventListener('click', handleEdit);
                button.addEventListener('click', handleEdit);
            });
            document.querySelectorAll('.delete-post').forEach(button => {
                button.removeEventListener('click', handleDelete);
                button.addEventListener('click', handleDelete);
            });
        }

        // Load posts
        async function loadPosts() {
            const postList = document.getElementById('post-list');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            postList.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div></div>';
            loading.classList.remove('hidden');
            error.classList.add('hidden');

            try {
                const response = await fetch('/api/list-posts?t=' + Date.now(), {
                    signal: AbortSignal.timeout(10000)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('Raw response from list-posts:', errorText);
                    throw new Error(`Failed to fetch posts: ${response.status}`);
                }
                try {
                    allPosts = await response.json();
                    filteredPosts = [...allPosts];
                    console.log('Parsed posts:', allPosts);
                } catch (jsonError) {
                    const rawResponse = await response.text();
                    console.log('Raw response on JSON error:', rawResponse);
                    throw new Error('Invalid JSON response: ' + rawResponse);
                }
                displayPosts(filteredPosts);
            } catch (err) {
                error.textContent = 'Failed to fetch posts: ' + err.message;
                error.classList.remove('hidden');
                postList.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load posts</p>';
            } finally {
                loading.classList.add('hidden');
            }
        }

        function handleEdit(e) {
            const slug = e.target.dataset.slug;
            if (!slug) {
                console.log('No slug for edit button');
                return;
            }
            const post = allPosts.find(p => p.slug === slug);
            if (!post) {
                console.log('Post not found for slug:', slug);
                return;
            }
            document.querySelector('input[name="title"]').value = post.title || '';
            document.querySelector('input[name="slug"]').value = post.slug || '';
            document.querySelector('input[name="category"]').value = post.category || '';
            document.querySelector('input[name="tags"]').value = Array.isArray(post.tags) ? post.tags.join(', ') : post.tags || '';
            document.querySelector('input[name="image"]').value = post.image || '';
            document.querySelector('input[name="date"]').value = post.date || '';
            $('#content-editor').summernote('code', post.content || '');
            document.getElementById('submit-post-button').textContent = 'Update Post';
            document.getElementById('cancel-edit-button').classList.remove('hidden');
            document.getElementById('create-post').dataset.editSlug = slug;
        }

        function handleDelete(e) {
            const slug = e.target.dataset.slug;
            if (!slug) {
                console.log('No slug for delete button');
                return;
            }
            if (!confirm('Delete this post?')) return;
            fetch('/api/delete-post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ slug }).toString(),
                signal: AbortSignal.timeout(10000)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(errorText => {
                            console.log('Raw delete response:', errorText);
                            throw new Error(`Failed to delete post: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Delete response:', data);
                    if (document.getElementById('create-post').dataset.editSlug === slug) {
                        document.getElementById('create-post').reset();
                        $('#content-editor').summernote('reset');
                        document.getElementById('submit-post-button').textContent = 'Create Post';
                        document.getElementById('cancel-edit-button').classList.add('hidden');
                        delete document.getElementById('create-post').dataset.editSlug;
                    }
                    loadPosts();
                })
                .catch(err => {
                    document.getElementById('error').textContent = 'Failed to delete post: ' + err.message;
                    document.getElementById('error').classList.remove('hidden');
                });
        }
    </script>
</body>
</html>