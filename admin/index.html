<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tiny.cloud/1/mn8k8hdz6yfspjdieakr2wj6o17ul3zukzga01gsm1jdi0gp/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
    <div id="login-section">
        <form id="login-form">
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        <p id="login-error" style="color: red; display: none;"></p>
    </div>

    <div id="admin-section" style="display: none;">
        <h2>Create Post</h2>
        <form id="create-post">
            <div>
                <label>Title</label>
                <input type="text" name="title" required>
            </div>
            <div>
                <label>Slug</label>
                <input type="text" name="slug" required>
            </div>
            <div>
                <label>Category</label>
                <input type="text" name="category">
            </div>
            <div>
                <label>Tags (comma-separated)</label>
                <input type="text" name="tags">
            </div>
            <div>
                <label>Image URL</label>
                <input type="text" name="image">
            </div>
            <div>
                <label>Date</label>
                <input type="date" name="date" required>
            </div>
            <div>
                <label>Content</label>
                <textarea id="content-editor" name="content" rows="10"></textarea>
            </div>
            <button type="submit" id="submit-post-button">Create Post</button>
            <button type="button" id="cancel-edit-button" style="display: none;">Cancel Edit</button>
        </form>
        <p id="error" style="color: red; display: none;"></p>
        <p id="loading" style="color: blue; display: none;">Loading...</p>

        <h2 id="posts-title">Posts</h2>
        <div id="post-list"></div>
    </div>

    <script>
        let allPosts = [];

        // Initialize TinyMCE
        tinymce.init({
            selector: '#content-editor',
            plugins: 'lists link image',
            toolbar: 'undo redo | bold italic | bullist numlist | link image',
            menubar: false,
            height: 300,
            setup: (editor) => {
                editor.on('init', () => {
                    console.log('TinyMCE initialized');
                });
            }
        });

        // Ensure TinyMCE is ready
        function waitForTinyMCE(callback) {
            if (tinymce.get('content-editor')) {
                callback();
            } else {
                setTimeout(() => waitForTinyMCE(callback), 100);
            }
        }

        // Login handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const error = document.getElementById('login-error');
            error.style.display = 'none';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ password }).toString()
                });
                if (response.ok) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-section').style.display = 'block';
                    await loadPosts();
                } else {
                    const data = await response.json();
                    error.textContent = data.error || 'Invalid password';
                    error.style.display = 'block';
                }
            } catch (err) {
                error.textContent = 'Login failed: ' + err.message;
                error.style.display = 'block';
            }
        });

        // Create/Update post handler
        document.getElementById('create-post').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const submitButton = document.getElementById('submit-post-button');
            loading.style.display = 'block';
            error.style.display = 'none';
            submitButton.disabled = true;

            const formData = new FormData(e.target);
            const postData = {
                title: formData.get('title'),
                slug: formData.get('slug'),
                category: formData.get('category'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag).join(','),
                image: formData.get('image') || '',
                date: formData.get('date'),
                content: tinymce.get('content-editor') ? tinymce.get('content-editor').getContent({ format: 'text' }) : formData.get('content')
            };

            try {
                const endpoint = e.target.dataset.editSlug ? '/api/update-post' : '/api/save-post';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(postData).toString()
                });
                let responseData;
                try {
                    responseData = await response.json();
                    console.log('Save/Update response:', responseData);
                } catch (jsonError) {
                    console.log('Raw response:', await response.text());
                    throw new Error('Invalid JSON response');
                }
                if (!response.ok) {
                    throw new Error(responseData.error || `Operation failed: ${response.status}`);
                }
                e.target.reset();
                if (tinymce.get('content-editor')) {
                    tinymce.get('content-editor').setContent('');
                }
                submitButton.textContent = 'Create Post';
                document.getElementById('cancel-edit-button').style.display = 'none';
                delete e.target.dataset.editSlug;
                await loadPosts();
            } catch (err) {
                error.textContent = `Failed to ${e.target.dataset.editSlug ? 'update' : 'create'} post: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                submitButton.disabled = false;
            }
        });

        // Cancel edit handler
        document.getElementById('cancel-edit-button').addEventListener('click', () => {
            document.getElementById('create-post').reset();
            if (tinymce.get('content-editor')) {
                tinymce.get('content-editor').setContent('');
            }
            document.getElementById('submit-post-button').textContent = 'Create Post';
            document.getElementById('cancel-edit-button').style.display = 'none';
            delete document.getElementById('create-post').dataset.editSlug;
        });

        // Load posts
        async function loadPosts() {
            const postList = document.getElementById('post-list');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const postsTitle = document.getElementById('posts-title');
            postList.innerHTML = '';
            loading.style.display = 'block';
            error.style.display = 'none';

            try {
                const response = await fetch('/api/list-posts?t=' + Date.now());
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('Raw response from list-posts:', errorText);
                    throw new Error(`Failed to fetch posts: ${response.status}`);
                }
                try {
                    allPosts = await response.json();
                    console.log('Parsed posts:', allPosts);
                } catch (jsonError) {
                    console.log('Raw response on JSON error:', await response.text());
                    throw new Error('Invalid JSON response');
                }
                postsTitle.textContent = `Posts (${allPosts.length})`;

                if (allPosts.length === 0) {
                    postList.innerHTML = '<p>No posts yet.</p>';
                } else {
                    postList.innerHTML = allPosts.map(post => `
                        <div style="margin-bottom: 1rem;">
                            <span>${post.title || 'Untitled'}</span>
                            <button class="edit-post" data-slug="${post.slug || ''}" style="margin-left: 1rem;">Edit</button>
                            <button class="delete-post" data-slug="${post.slug || ''}" style="margin-left: 0.5rem;">Delete</button>
                        </div>
                    `).join('');
                }

                // Bind event listeners
                document.querySelectorAll('.edit-post').forEach(button => {
                    button.removeEventListener('click', handleEdit);
                    button.addEventListener('click', handleEdit);
                });

                document.querySelectorAll('.delete-post').forEach(button => {
                    button.removeEventListener('click', handleDelete);
                    button.addEventListener('click', handleDelete);
                });

                function handleEdit(e) {
                    const slug = e.target.dataset.slug;
                    if (!slug) {
                        console.log('No slug for edit button');
                        return;
                    }
                    const post = allPosts.find(p => p.slug === slug);
                    if (!post) {
                        console.log('Post not found for slug:', slug);
                        return;
                    }
                    document.querySelector('input[name="title"]').value = post.title || '';
                    document.querySelector('input[name="slug"]').value = post.slug || '';
                    document.querySelector('input[name="category"]').value = post.category || '';
                    document.querySelector('input[name="tags"]').value = Array.isArray(post.tags) ? post.tags.join(', ') : post.tags || '';
                    document.querySelector('input[name="image"]').value = post.image || '';
                    document.querySelector('input[name="date"]').value = post.date || '';
                    waitForTinyMCE(() => {
                        const content = post.content || '';
                        if (tinymce.get('content-editor')) {
                            tinymce.get('content-editor').setContent(content);
                            console.log('Content set in TinyMCE:', content);
                        } else {
                            document.getElementById('content-editor').value = content;
                        }
                    });
                    document.getElementById('submit-post-button').textContent = 'Update Post';
                    document.getElementById('cancel-edit-button').style.display = 'inline-block';
                    document.getElementById('create-post').dataset.editSlug = slug;
                }

                function handleDelete(e) {
                    const slug = e.target.dataset.slug;
                    if (!slug) {
                        console.log('No slug for delete button');
                        return;
                    }
                    if (!confirm('Delete this post?')) return;
                    fetch('/api/delete-post', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ slug }).toString()
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(errorText => {
                                    console.log('Raw delete response:', errorText);
                                    throw new Error(`Failed to delete post: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Delete response:', data);
                            if (document.getElementById('create-post').dataset.editSlug === slug) {
                                document.getElementById('create-post').reset();
                                if (tinymce.get('content-editor')) {
                                    tinymce.get('content-editor').setContent('');
                                }
                                document.getElementById('submit-post-button').textContent = 'Create Post';
                                document.getElementById('cancel-edit-button').style.display = 'none';
                                delete document.getElementById('create-post').dataset.editSlug;
                            }
                            loadPosts();
                        })
                        .catch(err => {
                            document.getElementById('error').textContent = 'Failed to delete post: ' + err.message;
                            document.getElementById('error').style.display = 'block';
                        });
                }
            } catch (err) {
                error.textContent = 'Failed to fetch posts: ' + err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>