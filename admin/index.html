<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Jonathan Mwaniki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tiny.cloud/1/mn8k8hdz6yfspjdieakr2wj6o17ul3zukzga01gsm1jdi0gp/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        .hidden { display: none; }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 50;
            transition: opacity 0.5s ease-in-out;
        }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="notification-container" class="fixed top-4 right-4 z-50"></div>

    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md mx-4">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Login</h2>
            <form id="login-form">
                <input type="password" id="password" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter admin password" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">Login</button>
            </form>
            <p id="login-error" class="text-red-500 mt-4 text-center hidden"></p>
        </div>
    </div>

    <div id="admin-section" class="min-h-screen p-6 hidden">
        <div class="max-w-3xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Create Post</h2>
            <form id="create-post" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" name="title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                    <input type="text" name="slug" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <input type="text" name="category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma-separated)</label>
                    <input type="text" name="tags" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                    <input type="text" name="image" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" name="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                    <textarea id="content-editor" name="content" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                </div>
                <button type="submit" class="bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Create Post</button>
            </form>
            <p id="error" class="text-red-500 text-center hidden"></p>
            <p id="loading" class="text-blue-500 text-center hidden">Loading...</p>

            <h2 class="text-3xl font-bold text-gray-800 mb-6">Posts</h2>
            <div id="post-list" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // Notification function to replace alerts
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type} opacity-100`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        tinymce.init({
            selector: '#content-editor',
            plugins: 'lists link image',
            toolbar: 'undo redo | bold italic | bullist numlist | link image',
            menubar: false,
            height: 300
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const error = document.getElementById('login-error');
            error.classList.add('hidden');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ password }).toString()
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('admin-section').classList.remove('hidden');
                    showNotification('Logged in successfully', 'success');
                    loadPosts();
                } else {
                    error.textContent = data.error || 'Invalid password';
                    error.classList.remove('hidden');
                    showNotification('Login failed: ' + (data.error || 'Invalid password'), 'error');
                }
            } catch (err) {
                error.textContent = 'Failed to login: ' + err.message;
                error.classList.remove('hidden');
                showNotification('Login error: ' + err.message, 'error');
            }
        });

        document.getElementById('create-post').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            loading.classList.remove('hidden');
            error.classList.add('hidden');

            const formData = new FormData(e.target);
            const postData = {
                title: formData.get('title'),
                slug: formData.get('slug'),
                category: formData.get('category'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag).join(','),
                image: formData.get('image') || '',
                date: formData.get('date'),
                content: tinymce.get('content-editor') ? tinymce.get('content-editor').getContent({ format: 'text' }) : formData.get('content')
            };

            try {
                const endpoint = e.target.dataset.editSlug ? '/api/update-post' : '/api/save-post';
                showNotification(`Sending ${e.target.dataset.editSlug ? 'update' : 'create'} post request`, 'info');
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(postData).toString()
                });
                let responseData;
                try {
                    responseData = await response.json();
                    showNotification(`Post ${e.target.dataset.editSlug ? 'updated' : 'created'}: Status ${response.status}`, 'success');
                } catch (jsonError) {
                    showNotification('Invalid server response', 'error');
                    throw new Error('Invalid JSON response from server');
                }
                if (!response.ok) {
                    throw new Error(responseData.error || `Operation failed: ${response.status}`);
                }
                e.target.reset();
                if (tinymce.get('content-editor')) tinymce.get('content-editor').setContent('');
                e.target.querySelector('button[type="submit"]').textContent = 'Create Post';
                delete e.target.dataset.editSlug;
                showNotification('Post saved successfully', 'success');
                loadPosts();
            } catch (err) {
                error.textContent = `Failed to ${e.target.dataset.editSlug ? 'update' : 'create'} post: ${err.message}`;
                error.classList.remove('hidden');
                showNotification(`Error: ${err.message}`, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        });

        async function loadPosts() {
            const postList = document.getElementById('post-list');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            postList.innerHTML = '';
            loading.classList.remove('hidden');
            error.classList.add('hidden');

            try {
                showNotification('Fetching posts', 'info');
                const response = await fetch('/api/list-posts?t=' + Date.now());
                if (!response.ok) {
                    const errorText = await response.text();
                    showNotification('Failed to fetch posts', 'error');
                    throw new Error(`Failed to fetch posts: ${response.status}`);
                }
                let posts;
                try {
                    posts = await response.json();
                    showNotification(`Loaded ${posts.length} posts`, 'success');
                } catch (jsonError) {
                    showNotification('Invalid post data', 'error');
                    throw new Error('Invalid JSON response from server');
                }
                if (posts.error) throw new Error(posts.error);
                posts.forEach(post => {
                    const postItem = document.createElement('div');
                    postItem.className = 'bg-white p-4 rounded-lg shadow-md flex justify-between items-center hover:shadow-xl transition-shadow';
                    postItem.innerHTML = `
                        <div>
                            <h4 class="text-lg font-medium text-gray-900">${post.title}</h4>
                            <p class="text-sm text-gray-500">${post.date} | ${post.category}</p>
                        </div>
                        <div class="space-x-2">
                            <button class="edit-post bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors" data-slug="${post.slug}">Edit</button>
                            <button class="delete-post bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors" data-slug="${post.slug}">Delete</button>
                        </div>
                    `;
                    postList.appendChild(postItem);
                });

                document.querySelectorAll('.edit-post').forEach(button => {
                    button.addEventListener('click', async () => {
                        const slug = button.dataset.slug;
                        showNotification(`Fetching post ${slug}`, 'info');
                        try {
                            const response = await fetch('/api/list-posts?t=' + Date.now());
                            let posts;
                            try {
                                posts = await response.json();
                                showNotification(`Loaded ${posts.length} posts for edit`, 'success');
                            } catch (jsonError) {
                                showNotification('Invalid post data', 'error');
                                throw new Error('Invalid JSON response from server');
                            }
                            const post = posts.find(p => p.slug === slug);
                            if (post) {
                                document.querySelector('input[name="title"]').value = post.title;
                                document.querySelector('input[name="slug"]').value = post.slug;
                                document.querySelector('input[name="category"]').value = post.category;
                                document.querySelector('input[name="tags"]').value = post.tags.join(', ');
                                document.querySelector('input[name="image"]').value = post.image || '';
                                document.querySelector('input[name="date"]').value = post.date;
                                if (tinymce.get('content-editor')) {
                                    tinymce.get('content-editor').setContent(post.content || '');
                                } else {
                                    document.getElementById('content-editor').value = post.content || '';
                                }
                                document.querySelector('#create-post button[type="submit"]').textContent = 'Update Post';
                                document.querySelector('#create-post').dataset.editSlug = slug;
                                showNotification('Post loaded for editing', 'success');
                            }
                        } catch (err) {
                            error.textContent = 'Failed to load post: ' + err.message;
                            error.classList.remove('hidden');
                            showNotification(`Error loading post: ${err.message}`, 'error');
                        }
                    });
                });

                document.querySelectorAll('.delete-post').forEach(button => {
                    button.addEventListener('click', async () => {
                        if (!confirm('Are you sure you want to delete this post?')) return;
                        const slug = button.dataset.slug;
                        showNotification(`Deleting post ${slug}`, 'info');
                        try {
                            const response = await fetch('/api/delete-post', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: new URLSearchParams({ slug }).toString()
                            });
                            let responseData;
                            try {
                                responseData = await response.json();
                                showNotification('Post deleted successfully', 'success');
                            } catch (jsonError) {
                                showNotification('Invalid server response', 'error');
                                throw new Error('Invalid JSON response from server');
                            }
                            if (!response.ok) {
                                throw new Error(responseData.error || 'Failed to delete post');
                            }
                            loadPosts();
                        } catch (err) {
                            error.textContent = 'Failed to delete post: ' + err.message;
                            error.classList.remove('hidden');
                            showNotification(`Error deleting post: ${err.message}`, 'error');
                        }
                    });
                });
            } catch (err) {
                error.textContent = `Failed to fetch posts: ${err.message}`;
                error.classList.remove('hidden');
                showNotification(`Error fetching posts: ${err.message}`, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }
    </script>
</body>
</html>